name: Sync docs to Wiki

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Clone wiki and ensure `master` exists
        run: |
          set -euo pipefail
          git clone "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.wiki.git" wiki

          # If the wiki doesn't have a master branch, create it.
          if ! git -C wiki ls-remote --heads origin master | grep -q 'refs/heads/master'; then
            echo "No 'master' branch on wiki; creating it."
            git -C wiki checkout --orphan master
            rm -rf wiki/*
            echo "# Wiki" > wiki/Home.md
            git -C wiki add -A
            git -C wiki commit -m "chore(wiki): initialize master branch"
            git -C wiki push origin master
          fi

          # Make sure we're on master locally
          git -C wiki checkout master || git -C wiki switch master

      - name: Sync docs -> wiki and generate Home/_Sidebar (wiki-style links)
        run: |
          set -euo pipefail

          shopt -s dotglob nullglob

          # Clean wiki (keep .git)
          find wiki -mindepth 1 -maxdepth 1 ! -name ".git" -exec rm -rf {} +

          # Copy docs content into wiki (keeps structure & assets)
          rsync -a --exclude '.git' --exclude '.github' docs/ wiki/ || true

          # Helper: title from first H1 (trim), else filename prettified (safe if no H1)
          title_from_file () {
            local f="$1"
            local h
            h="$(sed -n 's/^#\{1,\}[[:space:]]\{0,\}//p;q' "$f")"
            if [ -n "${h:-}" ]; then
              printf '%s\n' "$(printf '%s' "$h" | sed 's/[[:space:]]\+$//')"
            else
              basename "$f" .md | sed 's/[_-]/ /g'
            fi
          }

          # === Generate Home.md (index) with Wiki-style links ===
          {
            echo "# Project Docs"
            echo
            echo "This page is auto-generated from \`docs/\`."
            echo

            echo "## Top-level"
            root_mds=$(find wiki -maxdepth 1 -type f -name "*.md" ! -name "Home.md" ! -name "_Sidebar.md" | sort)
            if [ -n "$root_mds" ]; then
              while IFS= read -r f; do
                [ -z "$f" ] && continue
                t="$(title_from_file "$f")"
                base="$(basename "$f" .md)"
                echo "- [[${base}|$t]]"
              done <<< "$root_mds"
            else
              echo "- (none)"
            fi
            echo

            dirs=$(find wiki -mindepth 1 -maxdepth 1 -type d ! -name ".git" | sort)
            if [ -n "$dirs" ]; then
              while IFS= read -r d; do
                [ -z "$d" ] && continue
                dname="$(basename "$d")"
                echo "## $dname"
                files=$(find "$d" -maxdepth 1 -type f -name "*.md" ! -name "Home.md" ! -name "_Sidebar.md" | sort)
                if [ -n "$files" ]; then
                  while IFS= read -r f; do
                    [ -z "$f" ] && continue
                    t="$(title_from_file "$f")"
                    fname="$(basename "$f")"
                    base="${fname%.md}"
                    echo "- [[${dname}/${base}|$t]]"
                  done <<< "$files"
                else
                  echo "- (none)"
                fi
                echo
              done <<< "$dirs"
            fi
          } > wiki/Home.md

          # === Generate _Sidebar.md (Wiki-style links) ===
          tmp_sidebar="$(mktemp)"
          echo "- [[Home]]" >> "$tmp_sidebar"

          root_mds=$(find wiki -maxdepth 1 -type f -name "*.md" ! -name "Home.md" ! -name "_Sidebar.md" | sort)
          if [ -n "$root_mds" ]; then
            while IFS= read -r f; do
              [ -z "$f" ] && continue
              t="$(title_from_file "$f")"
              base="$(basename "$f" .md)"
              echo "- [[${base}|$t]]" >> "$tmp_sidebar"
            done <<< "$root_mds"
          fi

          dirs=$(find wiki -mindepth 1 -maxdepth 1 -type d ! -name ".git" | sort)
          if [ -n "$dirs" ]; then
            while IFS= read -r d; do
              [ -z "$d" ] && continue
              dname="$(basename "$d")"
              echo "- $dname" >> "$tmp_sidebar"
              files=$(find "$d" -maxdepth 1 -type f -name "*.md" ! -name "Home.md" ! -name "_Sidebar.md" | sort)
              if [ -n "$files" ]; then
                while IFS= read -r f; do
                  [ -z "$f" ] && continue
                  t="$(title_from_file "$f")"
                  fname="$(basename "$f")"
                  base="${fname%.md}"
                  echo "  - [[${dname}/${base}|$t]]" >> "$tmp_sidebar"
                done <<< "$files"
              fi
            done <<< "$dirs"
          fi

          mv "$tmp_sidebar" wiki/_Sidebar.md

      - name: Commit & Push to wiki (master only)
        working-directory: wiki
        run: |
          set -euo pipefail
          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "chore(wiki): sync from docs (${GITHUB_SHA}) with auto-generated Home.md and _Sidebar.md"
            git push origin HEAD:master
          else
            echo "No changes to commit."
          fi
